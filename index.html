
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Paris Blog</title>
  <meta name="author" content="Han-Chun Yeh (Paris)">

  
  <meta name="description" content="QPNP (Qualcomm Plug Plug N Play) vibrator is a peripheral on Qualcomm PMICs. The PMIC is connected to MSM8909 via SPMI bus.
Its driver uses the timed &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pyeh.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Paris Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Paris Blog</a></h1>
  
    <h2>A blog or note for software development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pyeh.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/22/android-vibrator-on-msm8909-platform/">Android Vibrator on MSM8909 Platform</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-22T23:38:00+08:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>QPNP (Qualcomm Plug Plug N Play) vibrator is a peripheral on Qualcomm PMICs. The PMIC is connected to MSM8909 via SPMI bus.
Its driver uses the timed-output framework to interface with the userspace.</p>

<h3>1. MSM8909 Vibrator driver implementation and DTS file</h3>

<p>The vibrator is connected on the VIB_DRV_N line of the QPNP PMIC, and the PMIC vibrator driver can be used to program the voltage from 1.2 V to 3.1 V in 100 mV step through VIB_DRV_N pin.</p>

<h4>DTSI documentation</h4>

<figure class='code'><figcaption><span>kernel/arch/arm/boot/dts/qcom/msm-pm8909.dtsi</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>            <span class="nl">pm8909_vib:</span> <span class="n">qcom</span><span class="p">,</span><span class="n">vibrator</span><span class="err">@</span><span class="n">c000</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;qcom,qpnp-vibrator&quot;</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0xc000</span> <span class="mh">0x100</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;vibrator&quot;</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;disabled&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Documentation/devicetree/bindings/platform/msm/qpnp-vibrator.txt</h4>

<h5>Required Properties:</h5>

<pre><code>- status: default status is set to "disabled.  Must be "okay"  
- compatible: must be "qcom,qpnp-vibrator"  
- label: name which describes the device  
- reg: address of device  
</code></pre>

<h5>Optional Properties:</h5>

<pre><code>- qcom,vib-timeout-ms: timeout of vibrator, in ms.  Default 15000 ms  
- qcom,vib-vtg-level-mV: voltage level, in mV.  Default 3100 mV  
</code></pre>

<h4>vibrator driver source</h4>

<p>QPNP vibrator operates in two modes &ndash; manual and PWM (Pulse Width Modulation). PWM is supported
through one of dtest lines connected to the vibrator. Manual mode is used on MSM8909 platform.</p>

<figure class='code'><figcaption><span>qpnp_vibrator_prboe() under kernel/drivers/platform/msm/qpnp-vibrator.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">qpnp_vibrator_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spmi_device</span> <span class="o">*</span><span class="n">spmi</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">qpnp_vib</span> <span class="o">*</span><span class="n">vib</span><span class="p">;</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">vib_resource</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vib</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vib</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vib</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">spmi</span> <span class="o">=</span> <span class="n">spmi</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vib_resource</span> <span class="o">=</span> <span class="n">spmi_get_resource</span><span class="p">(</span><span class="n">spmi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vib_resource</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get vibrator base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">vib_resource</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">rc</span> <span class="o">=</span> <span class="n">qpnp_vib_parse_dt</span><span class="p">(</span><span class="n">vib</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DT parsing failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">rc</span> <span class="o">=</span> <span class="n">qpnp_vibrator_config</span><span class="p">(</span><span class="n">vib</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vib config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">qpnp_vib_update</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">qpnp_vib_timer_func</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">timed_dev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vibrator&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">timed_dev</span><span class="p">.</span><span class="n">get_time</span> <span class="o">=</span> <span class="n">qpnp_vib_get_time</span><span class="p">;</span>
</span><span class='line'>        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">timed_dev</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">qpnp_vib_enable</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vib</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">rc</span> <span class="o">=</span> <span class="n">timed_output_dev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">timed_dev</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Uses timed output framework</h4>

<p>callback <em>.enable</em> and <em>.get_time</em> of <em>struct timed_output_dev</em> is hooked by <code>qpnp_vib_enable()</code> and <code>qpnp_vib_get_time()</code>.</p>

<figure class='code'><figcaption><span>Implementation of qnp_vib_enable() and qpnp_vib_get_time()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">qpnp_vib_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">timed_output_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">qpnp_vib</span> <span class="o">*</span><span class="n">vib</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qpnp_vib</span><span class="p">,</span>
</span><span class='line'>                                         <span class="n">timed_dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">vib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">vib</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">?</span>
</span><span class='line'>                                 <span class="n">vib</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">:</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>                <span class="n">vib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">ktime_set</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">),</span>
</span><span class='line'>                              <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">qpnp_vib_get_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">timed_output_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">qpnp_vib</span> <span class="o">*</span><span class="n">vib</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qpnp_vib</span><span class="p">,</span>
</span><span class='line'>                                                         <span class="n">timed_dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ktime_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">hrtimer_get_remaining</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">vib_timer</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ktime_to_us</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>wq is scheduled to execute work of qpnp_vib_update() and turns off vibrator via qpnp_vibrator_suspend() at suspend callback.</h4>

<p>Inside <code>qpnp_vib_update()</code> and <code>qpnp_vibrator_suspend()</code>, they both call <code>qpnp_vib_set()</code> to turn on/off vibrator.</p>

<figure class='code'><figcaption><span>Implementation of qpnp_vib_set() to control vibrator via PWM or Manual Mode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">qpnp_vib_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">qpnp_vib</span> <span class="o">*</span><span class="n">vib</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">QPNP_VIB_MANUAL</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">pwm_enable</span><span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">pwm_info</span><span class="p">.</span><span class="n">pwm_dev</span><span class="p">);</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">val</span> <span class="o">=</span> <span class="n">vib</span><span class="o">-&gt;</span><span class="n">reg_en_ctl</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">val</span> <span class="o">|=</span> <span class="n">QPNP_VIB_EN</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">rc</span> <span class="o">=</span> <span class="n">qpnp_vib_write_u8</span><span class="p">(</span><span class="n">vib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">QPNP_VIB_EN_CTL</span><span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">reg_en_ctl</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">QPNP_VIB_MANUAL</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">pwm_disable</span><span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">pwm_info</span><span class="p">.</span><span class="n">pwm_dev</span><span class="p">);</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">val</span> <span class="o">=</span> <span class="n">vib</span><span class="o">-&gt;</span><span class="n">reg_en_ctl</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QPNP_VIB_EN</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">rc</span> <span class="o">=</span> <span class="n">qpnp_vib_write_u8</span><span class="p">(</span><span class="n">vib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">QPNP_VIB_EN_CTL</span><span class="p">(</span><span class="n">vib</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                                <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>                        <span class="n">vib</span><span class="o">-&gt;</span><span class="n">reg_en_ctl</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. Timed output class driver</h3>

<p>Timed output is a class drvier to allow changing a state and restore is automatically after a specfied timeout.
This exposes a user space interface under <em>/sys/class/timed_output/vibrator/enable</em> used by vibrator code.</p>

<figure class='code'><figcaption><span>kernel/drivers/staging/android/timed_output.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
</span><span class='line'>                <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">timed_output_dev</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">(</span><span class="n">tdev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">enable_store</span><span class="p">(</span>
</span><span class='line'>                <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
</span><span class='line'>                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">timed_output_dev</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">timed_output_dev_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">timed_output_dev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tdev</span> <span class="o">||</span> <span class="o">!</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">create_timed_output_class</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_count</span><span class="p">);</span>
</span><span class='line'>        <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">timed_output_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>                <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_enable</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">err_create_file</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tdev</span><span class="p">);</span>
</span><span class='line'>        <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">err_create_file:</span>
</span><span class='line'>        <span class="n">device_destroy</span><span class="p">(</span><span class="n">timed_output_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
</span><span class='line'>        <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">timed_output_dev_register</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. Android vibrator HAL</h3>

<p>Its interface to linux device drivers call with the specified timeout in millisecond via <code>vibrator_on()</code>.</p>

<figure class='code'><figcaption><span>hardware/libhardware_legacy/vibrator/vibrator.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define THE_DEVICE &quot;/sys/class/timed_output/vibrator/enable&quot;</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">sendit</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">nwr</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef QEMU_HARDWARE</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">qemu_check</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">qemu_control_command</span><span class="p">(</span> <span class="s">&quot;vibrator:%d&quot;</span><span class="p">,</span> <span class="n">timeout_ms</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">THE_DEVICE</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">nwr</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nwr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">nwr</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">vibrator_on</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* constant on, up to maximum allowed time */</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">sendit</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">vibrator_off</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">sendit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. Native layer through JNI between HAL and vibrator service</h3>

<p>Controls of vibrator service reaches via <code>vibratorOn()</code>, <code>vibratorOff()</code>, and <code>vibratorExists()</code>.</p>

<figure class='code'><figcaption><span>frameworks//base/services/core/jni/com_android_server_VibratorService.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">vibratorOn</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">timeout_ms</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ALOGI(&quot;vibratorOn\n&quot;);</span>
</span><span class='line'>    <span class="n">vibrator_on</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">vibratorOff</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// ALOGI(&quot;vibratorOff\n&quot;);</span>
</span><span class='line'>    <span class="n">vibrator_off</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">method_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;vibratorExists&quot;</span><span class="p">,</span> <span class="s">&quot;()Z&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vibratorExists</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;vibratorOn&quot;</span><span class="p">,</span> <span class="s">&quot;(J)V&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vibratorOn</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;vibratorOff&quot;</span><span class="p">,</span> <span class="s">&quot;()V&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vibratorOff</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">register_android_server_VibratorService</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jniRegisterNativeMethods</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;com/android/server/VibratorService&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">method_table</span><span class="p">,</span> <span class="n">NELEM</span><span class="p">(</span><span class="n">method_table</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5. Java Vibrator Service</h3>

<p>In application layer before controling vibrator, applications have to get the access to the vibrator service.
The control goes into the vibrator service (<em>Framework Layer</em>) thru binder inteface.
For example, App. creates Vibrator object and start the vibration via <code>startVibrationLocked(vib)</code>.</p>

<p>Inside <code>startVibrationLocked()</code>:</p>

<p>If mTimeout != 0, then call the JNI function <code>vibratorOn()</code>.
else, call the code, which handle the rhythmic vibration pattern, which intern call the <code>vibratorOn()</code> through <code>VibrateThread()</code>.</p>

<figure class='code'><figcaption><span>frameworks/base/services/core/java/com/android/server/VibratorService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// Lock held on mVibrations</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startVibrationLocked</span><span class="o">(</span><span class="kd">final</span> <span class="n">Vibration</span> <span class="n">vib</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mLowPowerMode</span>
</span><span class='line'>                <span class="o">&amp;&amp;</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUsageHint</span> <span class="o">!=</span> <span class="n">AudioAttributes</span><span class="o">.</span><span class="na">USAGE_NOTIFICATION_RINGTONE</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">mAppOpsService</span><span class="o">.</span><span class="na">checkAudioOperation</span><span class="o">(</span><span class="n">AppOpsManager</span><span class="o">.</span><span class="na">OP_VIBRATE</span><span class="o">,</span>
</span><span class='line'>                <span class="n">vib</span><span class="o">.</span><span class="na">mUsageHint</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mOpPkg</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">AppOpsManager</span><span class="o">.</span><span class="na">MODE_ALLOWED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mode</span> <span class="o">=</span> <span class="n">mAppOpsService</span><span class="o">.</span><span class="na">startOperation</span><span class="o">(</span><span class="n">AppOpsManager</span><span class="o">.</span><span class="na">getToken</span><span class="o">(</span><span class="n">mAppOpsService</span><span class="o">),</span>
</span><span class='line'>                <span class="n">AppOpsManager</span><span class="o">.</span><span class="na">OP_VIBRATE</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mOpPkg</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">AppOpsManager</span><span class="o">.</span><span class="na">MODE_ALLOWED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">AppOpsManager</span><span class="o">.</span><span class="na">MODE_ERRORED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Would be an error: vibrate from uid &quot;</span> <span class="o">+</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUid</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">mH</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">mVibrationRunnable</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">vib</span><span class="o">.</span><span class="na">mTimeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">doVibratorOn</span><span class="o">(</span><span class="n">vib</span><span class="o">.</span><span class="na">mTimeout</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mUsageHint</span><span class="o">);</span>
</span><span class='line'>        <span class="n">mH</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">mVibrationRunnable</span><span class="o">,</span> <span class="n">vib</span><span class="o">.</span><span class="na">mTimeout</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// mThread better be null here. doCancelVibrate should always be</span>
</span><span class='line'>        <span class="c1">// called before startNextVibrationLocked or startVibrationLocked.</span>
</span><span class='line'>        <span class="n">mThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VibrateThread</span><span class="o">(</span><span class="n">vib</span><span class="o">);</span>
</span><span class='line'>        <span class="n">mThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doVibratorOn</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">usageHint</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mInputDeviceVibrators</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Turning vibrator on for &quot;</span> <span class="o">+</span> <span class="n">millis</span> <span class="o">+</span> <span class="s">&quot; ms.&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mBatteryStatsService</span><span class="o">.</span><span class="na">noteVibratorOn</span><span class="o">(</span><span class="n">uid</span><span class="o">,</span> <span class="n">millis</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mCurVibUid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">vibratorCount</span> <span class="o">=</span> <span class="n">mInputDeviceVibrators</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">vibratorCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">AudioAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AudioAttributes</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">setUsage</span><span class="o">(</span><span class="n">usageHint</span><span class="o">)</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vibratorCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mInputDeviceVibrators</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">vibrate</span><span class="o">(</span><span class="n">millis</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">vibratorOn</span><span class="o">(</span><span class="n">millis</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/07/notes-of-debugging-the-kernel-using-ftrace/">Notes of Debugging the Kernel Using Ftrace</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-07T23:14:00+08:00" pubdate data-updated="true">Oct 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This page has my notes for debugging the kernel using Ftrace</p>

<p>Ftrace is a tracing utility built directly into the Linux kernel. Ftrace was introduced in kernel 2.6.27 by Steven Rostedy and Ingo Molnar. It comes with its own ring buffer for storing trace data, and uses the GCC profiling mechanism. Documentation for this can be found in the Linux kernel source tree at <a href="https://www.kernel.org/doc/Documentation/trace/ftrace.txt">Documentation/trace/ftrace.txt</a></p>

<h4>References:</h4>

<ul>
<li><a href="http://lwn.net/Articles/365835/">Debugging the kernel using Ftrace &ndash; part 1</a></li>
<li><a href="http://lwn.net/Articles/366796/">Debugging the kernel using Ftrace &ndash; part 2</a></li>
<li><a href="http://lwn.net/Articles/370423/">Secrets of the Ftrace function tracer</a></li>
</ul>


<h3>Setting up Ftrace:</h3>

<p>When Ftrace is configured, it will create its own directory called tracing within the debugfs file system.</p>

<pre><code>[~]# cd /sys/kernel/debug/tracing
[tracing]#
</code></pre>

<p>For the purpose of debugging, the kernel configuration parameters that should be enabled are:<br/>
*  Kernel Function Tracer (FUNCTION_TRACER)<br/>
*  Kernel Function Graph Tracer (FUNCTION_GRAPH_TRACER)<br/>
*  Enable/disable ftrace dynamically (DYNAMIC_FTRACE)</p>

<p>The function tracer uses the <em>-pg</em> of <em>gcc</em> to have every function in the kernel call a special funciton <code>mcount()</code>.
During the compilation the mcount() call-sites are recorded, and that list is used at boot time to convert those
call-sites to NOP when CONFIG_DYNAMIC_FTRACE is set.
When the function or function graph tracer is enabled, that list is saved to convert those call-sites back to trace calls.</p>

<p>To find out which tracers are available, simply cat the <em>available_tracers</em> file in the tracing directory:</p>

<pre><code>root@K015:/ # cat /d/tracing/available_tracers
blk function_graph wakeup_rt wakeup preemptirqsoff preemptoff irqsoff function nop
</code></pre>

<p>To enable the function tracer, just echo &ldquo;function&rdquo; into the <em>current_tracer</em> file.</p>

<pre><code>root@K015:/d/tracing # echo function &gt; current_tracer
root@K015:/d/tracing # cat&gt; tracer
# tracer: function
#
# entries-in-buffer/entries-written: 205147/172709617   #P:4
#
#                              _-----=&gt; irqs-off
#                             / _----=&gt; need-resched
#                            | / _---=&gt; hardirq/softirq
#                            || / _--=&gt; preempt-depth
#                            ||| /     delay
#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION
#              | |       |   ||||       |         |
        Binder_D-4038  [003] ....    98.468143: cgroup_tasks_write &lt;-cgroup_file_write
        Binder_D-4038  [003] ....    98.468143: attach_task_by_pid &lt;-cgroup_tasks_write
        Binder_D-4038  [003] ....    98.468143: cgroup_lock_live_group &lt;-attach_task_by_pid
        Binder_D-4038  [003] ....    98.468144: mutex_lock &lt;-cgroup_lock_live_group
        Binder_D-4038  [003] ....    98.468144: __might_sleep &lt;-mutex_lock
        Binder_D-4038  [003] ....    98.468144: __mutex_lock_slowpath &lt;-mutex_lock
        Binder_D-4038  [003] ....    98.468144: add_preempt_count &lt;-__mutex_lock_slowpath
        Binder_D-4038  [003] ...1    98.468145: sub_preempt_count &lt;-__mutex_lock_slowpath
        Binder_D-4038  [003] ....    98.468145: __rcu_read_lock &lt;-attach_task_by_pid
</code></pre>

<p>A header is printed with the tracer name that is represented by
the trace. In this case the tracer is &ldquo;function&rdquo;. Then it shows the
number of events in the buffer as well as the total number of entries
that were written. The difference is the number of entries that were
lost due to the buffer filling up (172709617 &ndash; 205147 = 172504407 events
lost). #P is the number of online CPUs (#P:4).</p>

<p>The header explains the content of the events. Task name &ldquo;Binder_D&rdquo;, the task
PID &ldquo;4038&rdquo;, the CPU that it was running on &ldquo;003&rdquo;, the latency format
(explained below), the timestamp in <secs>.<usecs> format, the
function name that was traced &ldquo;cgroup_tasks_write&rdquo; and the parent function that
called this function &ldquo;cgroup_file_write&rdquo;. The timestamp is the time
at which the function was entered.</p>

<pre><code>irqs-off: 'd' interrupts are disabled. '.' otherwise.
    Note: If the architecture does not support a way to
      read the irq flags variable, an 'X' will always
      be printed here.

need-resched:
'N' both TIF_NEED_RESCHED and PREEMPT_NEED_RESCHED is set,
'n' only TIF_NEED_RESCHED is set,
'p' only PREEMPT_NEED_RESCHED is set,
'.' otherwise.

hardirq/softirq:
'H' - hard irq occurred inside a softirq.
'h' - hard irq is running
's' - soft irq is running
'.' - normal context.

preempt-depth: The level of preempt_disabled
</code></pre>

<p>The above is mostly meaningful for kernel developers.</p>

<h3>Tips</h3>

<hr />

<h4>Using <em>trace_prink()</em></h4>

<p>If you are debugging a high volume area such as the timer interrupt, the scheduler, or the network, <em>printk()</em> can lead to bogging down the system or can even create a live lock.
It is also quite common to see a bug &ldquo;disappear&rdquo; when adding a few <em>printk()</em>s. This is due to the sheer overhead that <em>printk()</em> introduces.</p>

<p>Ftrace introduces a new form of <em>printk()</em> called <em>trace_printk()</em>.</p>

<p>For example, below code add entry/exit checkpoints to know how long system stays at standy mode</p>

<figure class='code'><figcaption><span>arch/x86/platform/intel-mid/intel_soc_pmu.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">mid_suspend_enter</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">PM_SUSPEND_MEM</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span><span class="o">&lt;</span><span class="n">SKIP</span><span class="o">&gt;</span><span class="p">...</span>
</span><span class='line'>        <span class="n">trace_printk</span><span class="p">(</span><span class="s">&quot;s3_entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">standby_enter</span><span class="p">();</span>
</span><span class='line'>        <span class="n">trace_printk</span><span class="p">(</span><span class="s">&quot;s3_exit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span><span class="o">&lt;</span><span class="n">SKIP</span><span class="o">&gt;</span><span class="p">...</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>trace_printk()</em> output will appear in any tracer, even the function and function graph tracers.</p>

<pre><code># tracer: nop
#
# entries-in-buffer/entries-written: 4/4   #P:4
#
#                              _-----=&gt; irqs-off
#                             / _----=&gt; need-resched
#                            | / _---=&gt; hardirq/softirq
#                            || / _--=&gt; preempt-depth
#                            ||| /     delay
#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION
#              | |       |   ||||       |         |
    kworker/u8:5-1178  [000] d...   318.726581: mid_suspend_enter: s3_entry
    kworker/u8:5-1178  [000] d...   377.664365: mid_suspend_enter: s3_exit 0
    kworker/u8:5-1178  [000] d...   378.514933: mid_suspend_enter: s3_entry
    kworker/u8:5-1178  [000] d...   569.010863: mid_suspend_enter: s3_exit 0
</code></pre>

<h4>Tracing a specific process</h4>

<p>Trace a specific process, or set of processes. The file set_ftrace_pid lets you specify specific processes that you want to trace.</p>

<pre><code>[tracing]# echo $$ &gt; set_ftrace_pid
</code></pre>

<p>The above will set the function tracer to only trace the bash shell that executed the echo command.</p>

<p>Clear the <em>set_ftrace_pid file</em> if you want to go back to generic function tracing</p>

<pre><code>[tracing]# echo -1 &gt; set_ftrace_pid
</code></pre>

<h4>Capturing Ftrace to oops when kernel panic</h4>

<p>You can capture the function calls leading up to a panic by placing the following on the kernel command line</p>

<pre><code>ftrace=function ftrace_dump_on_oops
</code></pre>

<p>or,  by echoing a &ldquo;1&rdquo; into <em>/proc/sys/kernel/ftrace_dump_on_oops</em>, will enable Ftrace to dump to the console the entire trace buffer in ASCII format on oops or panic.</p>

<h4>Find latencies on kernel startup</h4>

<p>Use the following on the kernel command line:</p>

<pre><code>tracing_thresh=10000 ftrace=function_graph
</code></pre>

<p>this traces all functions taking longer than 2000 microseconds (10 ms).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/12/android-renderscript-notes/">Android RenderScript Notes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-12T12:06:00+08:00" pubdate data-updated="true">Dec 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This page has my notes from initial study for Android RenderScript.</p>

<p>RenderScript is Android 3D graphics rendering and intensive computation using heterogeneous computing.<br/>
1. Portability: A general purpose compute API across different system computing hardware<br/>
2. High Performance<br/>
3. Developer Friendly: A compute API similar to CUDA, OpenCL or GLSL, and a familiar language with C99</p>

<p>There are three major components in RenderScript<br/>
1. Offline compiler (llvm-rs-cc): Convert script files into portable bitcode and reflected Java layer<br/>
2. Online JIT compiler (libbcc): Translate portable bitcode to appropriate machine code (CPU/GPU/DSP/&hellip;)<br/>
3. Runtime library support (libRS): Manage scripts from Dalvik layer and also provide basic support libraries (math functions, etc.)<br/>
A good introduciton of <a href="https://events.linuxfoundation.org/slides/2011/lfcs/lfcs2011_llvm_liao.pdf">Android RenderScript on LLVM</a> is given by Shih-Wei Liao, and a good comparsion and analysis of different <a href="https://www.google.com.tw/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=6&amp;cad=rja&amp;ved=0CGEQFjAF&amp;url=http%3A%2F%2Fwww.kandroid.org%2Fboard%2Fdata%2Fboard%2Fconference%2Ffile_in_body%2F1%2F6renderscript_2013_10_24_%25EC%2588%2598%25EC%25A0%2595.pdf&amp;ei=ACapUtGyKoGFoQSFv4GgBQ&amp;usg=AFQjCNGj_OC0Yl6ssx7s1EDFii2WmfLyiw&amp;sig2=Ng96XAtyU2Zkc2o7EGbA8g">android programming model</a> is given by Kandroid S/W Fundamentals Study Group at 12th Kandroid Conference, 2013.</p>

<p>Clang is offline frontend compiler to create LLVM bitcode and reflected Java layer. The portable bitcode supplied as a resource within .apk container and is compiled before use one the device. Offline compiler, llvm-rs-cc, performs machine-independent optimizations on host before emitting portable bitcode so that the online JIT on android devices can be light-weight.</p>

<p>Online JIT compiler, libbcc, performs target-specific optimizations and code generation and links dynamically against vendor-specific runtime library funcitons (lib*.bc). An example: RenderScript&rsquo;s runtime (libclcore.bc) comes with vector operations. Xoom&rsquo;s libclcore will have different CPU/GPU support (VFP3-16) than Nexus S&rsquo;s (NEON).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/06/intel-mide-cpuidle-intel-idle-processor-driver-and-new-c-states/">Intel_mide: CPUIDLE: Intel_idle Processor Driver and New C-States</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-06T17:34:00+08:00" pubdate data-updated="true">Dec 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When there is nothing left to do, the CPUs will go into the idle state to wait until it is needed again. These idle modes, which go by names like &ldquo;C states,&rdquo; vary in the amount of power saved, but also in the amount of ancillary information which may be lost and the amount of time required to get back into a fully-functional mode.</p>

<p>Intel_idle driver actually performs idle state power management, and regsiters into existing CPU Idle subsystem and extends driver for Merrifield CPU (Slivermont). It also introduces a new platform idle states C7x deeper than traditional C6 state. The overall idea is that CPU C7x-states are extended to devices and rest of the platform, hence puting the platform to S0ix states.</p>

<p>On intel mid platform (Merrifield), the PMU driver communicates with the Intel_idle driver, platform device drivers, pci drivers, and the PMU firmwares (NC: Punit, SC:SCU) to coordinate platform power state transitions.</p>

<ol>
<li><p>The PMU driver provides a platform-specific callback to the Intel_idle driver so that long periods of idleness can be extended to the entire platform.</p>

<ul>
<li>soc_s0ix_idle()&ndash;>enter_s0ix_state() // intel_idle driver defined at /drivers/idle/intel_idle.c</li>
<li>mid_s0ix_enter()            // PMU driver defined at /arch/x86/platform/intel-mid/intel_soc_pmu.c</li>
</ul>


<p> I could find out cpuidle_state->.enter() associated with soc_s0ix_idle() for C6 state on medfield platform, and the call stack looks like as above shown. However, I don&rsquo;t figure out the similar assoication between intel_idle and pmu driver on merrifield platform. I am curious if this statement is also appliciable on merrifield platform ??</p></li>
<li><p>Based on hint of idleness, the PMU driver extends CPU idleness to the reset of the platform via standard Linux PM_QoS, Runtime PM, and PCI PM calls.</p></li>
<li><p>Once the CPU and devices are all idle, the PMU driver programs the North and South Complex PMUs to implement the required power transitiion for S0ix to eumlate C7-x states.</p></li>
</ol>


<p>Here is very good reference to understand the cpuidle governor and subsystem
<a href="http://lwn.net/Articles/384146/">http://lwn.net/Articles/384146/</a> before digging into how intel_idle driver fits with current cpuilde intrastructure.</p>

<p>The below is code trace for intel_idle driver located at &ldquo;/drivers/idle/intel_idle.c&rdquo;
&ndash; Comment in intel_idle driver</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'> * intel_idle is a cpuidle driver that loads on specific Intel processors
</span><span class='line'> * in lieu of the legacy ACPI processor_idle driver.  The intent is to
</span><span class='line'> * make Linux more efficient on these processors, as intel_idle knows
</span><span class='line'> * more than ACPI, as well as make Linux more immune to ACPI BIOS bugs.
</span><span class='line'> */</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Driver Init.

<ul>
<li>intel_idle_probe() starts to match current CPU with array of x86_cpu_ids via and assign corresponding default cpuidle C-state table</li>
<li>intel_idle_cpuidle_driver_init() checks real C-state table and update its state when needed (eg, target_residency)</li>
<li>register the intel_dile driver with the cpudile subsystem through cpuidle_register_driver()</li>
<li>intel_idle_cpu_init() allocates, initializes, and registers cpuidle_device for each CPU</li>
<li>register cpu_hotplug_notifer to know about CPUs going up/dow</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>intel_idle_init()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">intel_idle_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Do not load intel_idle at all for now if idle= is passed */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">boot_option_idle_override</span> <span class="o">!=</span> <span class="n">IDLE_NO_OVERRIDE</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">retval</span> <span class="o">=</span> <span class="n">intel_idle_probe</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">intel_idle_cpuidle_driver_init</span><span class="p">();</span>
</span><span class='line'>        <span class="n">retval</span> <span class="o">=</span> <span class="n">cpuidle_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_idle_driver</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">struct</span> <span class="n">cpuidle_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">cpuidle_get_driver</span><span class="p">();</span>
</span><span class='line'>                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot;intel_idle yielding to %s&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">drv</span> <span class="o">?</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">intel_idle_cpuidle_devices</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuidle_device</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">intel_idle_cpuidle_devices</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">retval</span> <span class="o">=</span> <span class="n">intel_idle_cpu_init</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">cpuidle_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_idle_driver</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">platform_is</span><span class="p">(</span><span class="n">INTEL_ATOM_BYT</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="cm">/* Disable automatic core C6 demotion by PUNIT */</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">CLPU_CR_C6_POLICY_CONFIG</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">DISABLE_CORE_C6_DEMOTION</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
</span><span class='line'>                                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error to disable core C6 demotion&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="cm">/* Disable automatic module C6 demotion by PUNIT */</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">wrmsr_on_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">CLPU_MD_C6_POLICY_CONFIG</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">DISABLE_MODULE_C6_DEMOTION</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
</span><span class='line'>                                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error to disable module C6 demotion&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">register_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_hotplug_notifier</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ul>
<li>Default cpuidle C-states for merrifield

<ul>
<li>&ldquo;flags&rdquo; field describes the characteristics of this sleep state

<ul>
<li>CPUIDLE_FLAG_TIME_VALID should be set if it is possible to accurately measure the amount of time spent in this particular idle state.</li>
<li>CPUIDLE_FLAG_TLB_FLUSHED is set to inidicate the HW flushes the TLB for this state.</li>
<li>MWAIT takes an 8-bit &ldquo;hint&rdquo; in EAX &ldquo;suggesting&rdquo; the C-state (top nibble) and sub-state (bottom nibble). 0x00 means &ldquo;MWAIT(C1)&rdquo;, 0x10 means &ldquo;MWAIT(C2)&rdquo; etc.</li>
</ul>
</li>
<li>&ldquo;exit_latency&rdquo; in US says how long it takes to get back to a fully functional state.</li>
<li>&ldquo;target_residency&rdquo; in US is the minimum amount of time the processor should spend in this state to make the transition worth the effort.</li>
<li>The &ldquo;enter()&rdquo; function will be called when the current governor decides to put the CPU into the given state</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>Merrifield CPUidle C states</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#if defined(CONFIG_REMOVEME_INTEL_ATOM_MRFLD_POWER)</span>
</span><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">cpuidle_state</span> <span class="n">mrfld_cstates</span><span class="p">[</span><span class="n">CPUIDLE_STATE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="cm">/* MWAIT C1 */</span>
</span><span class='line'>                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;C1-ATM&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MWAIT 0x00&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MWAIT2flg</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_idle</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="cm">/* MWAIT C4 */</span>
</span><span class='line'>                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;C4-ATM&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MWAIT 0x30&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MWAIT2flg</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TLB_FLUSHED</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_idle</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="cm">/* MWAIT C6 */</span>
</span><span class='line'>                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;C6-ATM&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MWAIT 0x52&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MWAIT2flg</span><span class="p">(</span><span class="mh">0x52</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TLB_FLUSHED</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">560</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_idle</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="cm">/* MWAIT C7-S0i1 */</span>
</span><span class='line'>                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S0i1-ATM&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MWAIT 0x60&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MWAIT2flg</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TLB_FLUSHED</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_idle</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="cm">/* MWAIT C9-S0i3 */</span>
</span><span class='line'>                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S0i3-ATM&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MWAIT 0x64&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MWAIT2flg</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span> <span class="o">|</span> <span class="n">CPUIDLE_FLAG_TLB_FLUSHED</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_idle</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#define mrfld_cstates atom_cstates</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>The actual performs given C-state transitions implemented by intel_idle(). As we saw, this is done through &ldquo;enter()&rdquo; functions associated with each state. The decision as to which idle state makes sense in a given situation is very much a policy issue implemented by the cpuidle &ldquo;governors&rdquo;.</p>

<p>A call to enter() is a request from the current governor to put the CPU associated with dev into the given state. Note that enter() is free to choose a different state if there is a good reason to do so, but it should store the actual state used in the device&rsquo;s last_state field.</p>

<figure class='code'><figcaption><span>intel_idle</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/**                                                                                                                                 </span>
</span><span class='line'><span class="cm"> * intel_idle</span>
</span><span class='line'><span class="cm"> * @dev: cpuidle_device</span>
</span><span class='line'><span class="cm"> * @drv: cpuidle driver</span>
</span><span class='line'><span class="cm"> * @index: index of cpuidle state</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Must be called under local_irq_disable().</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuidle_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
</span><span class='line'>                <span class="k">struct</span> <span class="n">cpuidle_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ecx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* break on interrupt flag */</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">cpuidle_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eax</span> <span class="o">=</span> <span class="n">flg2MWAIT</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cstate</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if (defined(CONFIG_REMOVEME_INTEL_ATOM_MRFLD_POWER) &amp;&amp; \</span>
</span><span class='line'><span class="cp">        defined(CONFIG_PM_DEBUG))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>                <span class="cm">/* Get Cstate based on ignore table from PMU driver */</span>
</span><span class='line'>                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ncstate</span><span class="p">;</span>
</span><span class='line'>                <span class="n">cstate</span> <span class="o">=</span>
</span><span class='line'>                <span class="p">(((</span><span class="n">eax</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MWAIT_SUBSTATE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MWAIT_CSTATE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="n">ncstate</span> <span class="o">=</span> <span class="n">pmu_get_new_cstate</span><span class="p">(</span><span class="n">cstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
</span><span class='line'>                <span class="n">eax</span>     <span class="o">=</span> <span class="n">flg2MWAIT</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>        <span class="n">cstate</span> <span class="o">=</span> <span class="p">(((</span><span class="n">eax</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MWAIT_SUBSTATE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MWAIT_CSTATE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * leave_mm() to avoid costly and often unnecessary wakeups</span>
</span><span class='line'><span class="cm">         * for flushing the user TLB&#39;s associated with the active mm.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CPUIDLE_FLAG_TLB_FLUSHED</span><span class="p">)</span>
</span><span class='line'>                <span class="n">leave_mm</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lapic_timer_reliable_states</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cstate</span><span class="p">))))</span>
</span><span class='line'>                <span class="n">clockevents_notify</span><span class="p">(</span><span class="n">CLOCK_EVT_NOTIFY_BROADCAST_ENTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">__monitor</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                <span class="n">smp_mb</span><span class="p">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">())</span>
</span><span class='line'>                        <span class="n">__mwait</span><span class="p">(</span><span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span><span class="p">);</span>
</span><span class='line'><span class="cp">#if defined(CONFIG_REMOVEME_INTEL_ATOM_MDFLD_POWER) || \</span>
</span><span class='line'><span class="cp">        defined(CONFIG_REMOVEME_INTEL_ATOM_CLV_POWER)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">is_irq_pending</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">update_buckets</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lapic_timer_reliable_states</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cstate</span><span class="p">))))</span>
</span><span class='line'>                <span class="n">clockevents_notify</span><span class="p">(</span><span class="n">CLOCK_EVT_NOTIFY_BROADCAST_EXIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/04/intel-mid-android-power-management-flow-for-suspend-slash-resume-using-s0i3-implementation/">Intel_mid: Android Power Management Flow for Suspend/resume Using S0i3 Implementation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-04T11:19:00+08:00" pubdate data-updated="true">Dec 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The main PMU driver (arch/x86/platform/intel-mid/intel_soc_pmu.c) hooks to support Linux PM suspend/resume flows as follows.<br/>
The S0ix states are low-power active idle states that platform can be transitioned into.
&ndash; Register PMU driver as PCI device<br/>
The PMU driver registers mid_suspend_ops via suspend_set_ops().</p>

<figure class='code'><figcaption><span>mid_pci_register_init </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * mid_pci_register_init - register the PMU driver as PCI device</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">PMU_DRV_NAME</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">mid_pm_ids</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">mid_pmu_probe</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">mid_pmu_remove</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">mid_pmu_shutdown</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mid_pci_register_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mid_pmu_cxt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mid_pmu_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">mid_pmu_cxt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">s3_restrict_qos</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">s3_restrict_qos</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pm_qos_add_request</span><span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">s3_restrict_qos</span><span class="p">,</span>
</span><span class='line'>                         <span class="n">PM_QOS_CPU_DMA_LATENCY</span><span class="p">,</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">init_nc_device_states</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">nc_restrict_qos</span> <span class="o">=</span>
</span><span class='line'>                <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">nc_restrict_qos</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* initialize the semaphores */</span>
</span><span class='line'>        <span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">scu_ready_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* registering PCI device */</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
</span><span class='line'>        <span class="n">suspend_set_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_suspend_ops</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>mid_suspend_enter() performs the required S3 state over standby_enter()<br/>
check_nc_sc_status() hooked by mrfld_nc_sc_status_check (defind at arch/x86/platform/intel-mid/intel_soc_mrfld.c) is to check north complex (NC) and soutch complex (SC) device status. Return true if all NC and SC devices are in D0i3.</li>
</ul>


<figure class='code'><figcaption><span>mid_suspend_enter() </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_suspend_ops</span> <span class="n">mid_suspend_ops</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">mid_suspend_begin</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">mid_suspend_valid</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mid_suspend_prepare</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">prepare_late</span> <span class="o">=</span> <span class="n">mid_suspend_prepare_late</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="n">mid_suspend_enter</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">mid_suspend_end</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">mid_suspend_enter</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">PM_SUSPEND_MEM</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* one last check before entering standby */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pmu_ops</span><span class="o">-&gt;</span><span class="n">check_nc_sc_status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmu_ops</span><span class="o">-&gt;</span><span class="n">check_nc_sc_status</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">trace_printk</span><span class="p">(</span><span class="s">&quot;Device d0ix status check failed! Aborting Standby entry!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">trace_printk</span><span class="p">(</span><span class="s">&quot;s3_entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">standby_enter</span><span class="p">();</span>
</span><span class='line'>        <span class="n">trace_printk</span><span class="p">(</span><span class="s">&quot;s3_exit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">pmu_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
</span><span class='line'>                                <span class="s">&quot;Failed to enter S3 status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>standby_enter() performs requried S3 state

<ul>
<li>mid_state_to_sys_state() maps power states to driver&rsquo;s internal indexes.</li>
<li>mid_s01x_enter() performs required S3 state</li>
<li>__mwait(mid_pmu_cxt->s3_hint, 1) is issued with a hint to enter S0i3(S3 emulation using S0i3, as I observed that MRFLD_S3_HINT with 0x64 is same as MID_S0I3_STATE with 0x64). When both core issue an mwait C7, it is a hint provided by the idle driver to enter an S0ix state.</li>
<li>This triggers S0i3 entry, but the decision and policy is selected by SCU FW.</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>standby_enter()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">standby_enter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">s3_state</span> <span class="o">=</span> <span class="n">mid_state_to_sys_state</span><span class="p">(</span><span class="n">MID_S3_STATE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">mid_s0ix_enter</span><span class="p">(</span><span class="n">MID_S3_STATE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MID_S3_STATE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pmu_set_s0ix_complete</span><span class="p">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* time stamp for end of s3 entry */</span>
</span><span class='line'>        <span class="n">time_stamp_for_sleep_state_latency</span><span class="p">(</span><span class="n">s3_state</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">__monitor</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">smp_mb</span><span class="p">();</span>
</span><span class='line'>        <span class="n">__mwait</span><span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">s3_hint</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* time stamp for start of s3 exit */</span>
</span><span class='line'>        <span class="n">time_stamp_for_sleep_state_latency</span><span class="p">(</span><span class="n">s3_state</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pmu_set_s0ix_complete</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*set wkc to appropriate value suitable for s0ix*/</span>
</span><span class='line'>        <span class="n">writel</span><span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">ss_config</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">.</span><span class="n">wake_enable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>                       <span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">pmu_reg</span><span class="o">-&gt;</span><span class="n">pm_wkc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">writel</span><span class="p">(</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">ss_config</span><span class="o">-&gt;</span><span class="n">wake_state</span><span class="p">.</span><span class="n">wake_enable</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                       <span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">pmu_reg</span><span class="o">-&gt;</span><span class="n">pm_wkc</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">camera_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">display_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">platform_is</span><span class="p">(</span><span class="n">INTEL_ATOM_MRFLD</span><span class="p">))</span>
</span><span class='line'>                <span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">scu_ready_sem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>mid_s01x_enter()

<ul>
<li>pmu_prepare_wake() will mask wakeup from AONT timers for s3. If s3 is aborted for any reason, we don&rsquo;t want to leave AONT timers masked until next suspend, otherwise if next to happen is s0ix, no timer could wakeup SoC from s0ix and we might miss to kick the kernel watchdog.</li>
<li>enter() hooked by mrfld_pmu_enter (defined at arch/x86/platform/intel-mid/intel_soc_mrfld.c). Compared to Medfield and Covertail platform, PM_CMD is not required to send to SCU.</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>mid_s01x_enter()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">mid_s0ix_enter</span><span class="p">(</span><span class="kt">int</span> <span class="n">s0ix_state</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pmu_ops</span> <span class="o">||</span> <span class="o">!</span><span class="n">pmu_ops</span><span class="o">-&gt;</span><span class="n">enter</span><span class="p">))</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* check if we can acquire scu_ready_sem</span>
</span><span class='line'><span class="cm">         * if we are not able to then do a c6 */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">scu_ready_sem</span><span class="p">))</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* If PMU is busy, we&#39;ll retry on next C6 */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">_pmu_read_status</span><span class="p">(</span><span class="n">PMU_BUSY_STATUS</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">scu_ready_sem</span><span class="p">);</span>
</span><span class='line'>                <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mid_pmu_cxt-&gt;scu_read_sem is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pmu_prepare_wake</span><span class="p">(</span><span class="n">s0ix_state</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* no need to proceed if schedule pending */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">need_resched</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pmu_stat_clear</span><span class="p">();</span>
</span><span class='line'>                <span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mid_pmu_cxt</span><span class="o">-&gt;</span><span class="n">scu_ready_sem</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* entry function for pmu driver ops */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pmu_ops</span><span class="o">-&gt;</span><span class="n">enter</span><span class="p">(</span><span class="n">s0ix_state</span><span class="p">))</span>
</span><span class='line'>                <span class="n">ret</span> <span class="o">=</span> <span class="n">s0ix_state</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">ret:</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/02/intel-mid-introduction-of-android-watchdog-and-kernel-watchdog/">Intel_mid: Introduction of Android Watchdogs and Kernel Watchdogs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-02T17:29:00+08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Watchdogs monitor software and hardware device and prevent whole system from hanging. After looking into android BSP running on intel mid, merrifield, platform, I will try to classfiy watchdog into the following types. The first two belong to native Android supporting, and the last three are specified to intel-mid platform.</p>

<h2>1. Android framework&rsquo;s Java* watchdog</h2>

<p>Deal with cases when any of the following locks is held for more than a minute or when ServerThread is busy.</p>

<p>&mdash; ThermalManagerService<br/>
&mdash; PowerManagerService<br/>
&mdash; WindowMangerService<br/>
&mdash; MountService<br/>
&mdash; NetworkManagementService<br/>
&mdash; ActivityMangerService</p>

<p>If one of above services hangs for one minute, the java watchdog kills it and results in restarting android&rsquo;s framework by killing the SystemServer.</p>

<h2>2. Device-critical services</h2>

<p>Critical services are declared as &ldquo;critical&rdquo; in the corresponding rc files (eg, ueventd, servicemanager). If critical services exist or crash more than four times in four minutes, the device will reboot into recovery mode. This feature is handled by the init process.</p>

<h2>3. Kernel watchdog leads to COLD_RESET</h2>

<p>The kernel watchdog prvents the operating system from hanging. The System Control Unit (SCU firmware) resets the platform when the kernel cannot schedule the watchdog daemon (/usr/bin/ia_watchdogd).</p>

<p>The driver located at /drivers/watchdog/intel_scu_watchdog_evo.c provides a /dev/watchdog device to access the kernel watchdog and ioctls to configure the timer. Since the SCU provides the functionality, all access to watchdog features are routed to the SCU via an IPC (see more PIC regitrations at arch/x86/platform/intel-mid/intel_mid_scu.c)</p>

<ul>
<li>Init code installs the driver</li>
</ul>


<figure class='code'><figcaption><span>watchdog_rpmsg_init()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">rpmsg_driver</span> <span class="n">watchdog_rpmsg</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">.</span><span class="n">drv</span><span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">drv</span><span class="p">.</span><span class="n">owner</span>      <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">watchdog_rpmsg_id_table</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">watchdog_rpmsg_probe</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">callback</span>       <span class="o">=</span> <span class="n">watchdog_rpmsg_cb</span><span class="p">,</span>
</span><span class='line'>        <span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">watchdog_rpmsg_remove</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">watchdog_rpmsg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">intel_mid_identify_cpu</span><span class="p">()</span> <span class="o">==</span> <span class="n">INTEL_MID_CPU_CHIP_TANGIER</span><span class="p">)</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">register_rpmsg_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_rpmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: watchdog driver: bad platform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef MODULE</span>
</span><span class='line'><span class="n">module_init</span><span class="p">(</span><span class="n">watchdog_rpmsg_init</span><span class="p">);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="n">rootfs_initcall</span><span class="p">(</span><span class="n">watchdog_rpmsg_init</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>create the /dev/watchdog only if the disabled_kernel_watchdog module parameter is not set. It gets the timer&rsquo;s configuration, registers reboot notifier, registers dump handler to irq#15, and adds sysfs/debugfs entries.</li>
</ul>


<figure class='code'><figcaption><span>watchdog_rpmsg_probe()->intel_scu_watchdog_init()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Init code */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_scu_watchdog_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">normal_wd_action</span>   <span class="o">=</span> <span class="n">SCU_COLD_RESET_ON_TIMEOUT</span><span class="p">;</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_wd_action</span>   <span class="o">=</span> <span class="n">SCU_COLD_RESET_ON_TIMEOUT</span><span class="p">;</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">shutdown_wd_action</span> <span class="o">=</span> <span class="n">SCU_COLD_OFF_ON_TIMEOUT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DEBUG_FS</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">panic_reboot_notifier</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Initially, we are not in shutdown mode */</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Check timeouts boot parameter */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">check_timeouts</span><span class="p">(</span><span class="n">pre_timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid timeouts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Reboot notifier */</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_notifier</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">reboot_notifier</span><span class="p">;</span>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_notifier</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_notifier</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;cannot register reboot notifier %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">error_stop_timer</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Do not publish the watchdog device when disable (TO BE REMOVED) */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_kernel_watchdog</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">WATCHDOG_MINOR</span><span class="p">;</span>
</span><span class='line'>                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;watchdog&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_scu_fops</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">);</span>
</span><span class='line'>                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_scu_fops</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Cannot register miscdev %d err =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">WATCHDOG_MINOR</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">goto</span> <span class="n">error_reboot_notifier</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* MSI #15 handler to dump registers */</span>
</span><span class='line'>        <span class="n">handle_mrfl_dev_ioapic</span><span class="p">(</span><span class="n">EXT_TIMER0_MSI</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">EXT_TIMER0_MSI</span><span class="p">,</span>
</span><span class='line'>                <span class="n">watchdog_warning_interrupt</span><span class="p">,</span>
</span><span class='line'>                <span class="n">IRQF_SHARED</span><span class="o">|</span><span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span> <span class="s">&quot;watchdog&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error requesting warning irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">EXT_TIMER0_MSI</span><span class="p">);</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error value returned is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">error_misc_register</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_INTEL_SCU_SOFT_LOCKUP</span>
</span><span class='line'>        <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">softlock_timer</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">disable_kernel_watchdog</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Disable kernel watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="cm">/* Make sure timer is stopped */</span>
</span><span class='line'>                <span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_stop</span><span class="p">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;cant disable timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DEBUG_FS</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">create_debugfs_entries</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Error creating debugfs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">error_debugfs_entry</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">started</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">create_watchdog_sysfs_files</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Error creating debugfs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">error_sysfs_entry</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">error_sysfs_entry:</span>
</span><span class='line'>        <span class="cm">/* Nothing special to do */</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_DEBUG_FS</span>
</span><span class='line'><span class="nl">error_debugfs_entry:</span>
</span><span class='line'>        <span class="cm">/* Remove entries done by create function */</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="nl">error_misc_register:</span>
</span><span class='line'>        <span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">miscdev</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nl">error_reboot_notifier:</span>
</span><span class='line'>        <span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_notifier</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nl">error_stop_timer:</span>
</span><span class='line'>        <span class="n">watchdog_stop</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>interrupt handler related to pre-timeout dumps kernel backtraces.</li>
</ul>


<figure class='code'><figcaption><span>watchdog_warning_interrupt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* warning interrupt handler */</span>
</span><span class='line'><span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">watchdog_warning_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;[SHTDWN] %s, WATCHDOG TIMEOUT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Let&#39;s reset the platform after dumping some data */</span>
</span><span class='line'>        <span class="n">trigger_all_cpu_backtrace</span><span class="p">();</span>
</span><span class='line'>        <span class="n">panic</span><span class="p">(</span><span class="s">&quot;Kernel Watchdog&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* This code should not be reached */</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>When power transisition happens, reboot_notifier is called for re-configuring watchdog timeouts and its default behavior.
COLD_RESET is set to reboot, and COLD_OFF is set to poewr halt and off. In case of a stucking rebooting or shutdown procedure, the platform will still could execute reset or power-off seperately.</li>
</ul>


<figure class='code'><figcaption><span>reboot_notifier</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Reboot notifier */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">reboot_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
</span><span class='line'>                           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span>
</span><span class='line'>                           <span class="kt">void</span> <span class="o">*</span><span class="n">another_unused</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">SYS_RESTART</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">SYS_HALT</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">SYS_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Reboot notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">watchdog_set_appropriate_timeouts</span><span class="p">())</span>
</span><span class='line'>                        <span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;reboot notifier cant set time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">case</span> <span class="n">SYS_RESTART</span>:
</span><span class='line'>                        <span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_set_reset_type</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">reboot_wd_action</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">case</span> <span class="n">SYS_HALT</span>:
</span><span class='line'>                <span class="k">case</span> <span class="n">SYS_POWER_OFF</span>:
</span><span class='line'>                        <span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_set_reset_type</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">watchdog_device</span><span class="p">.</span><span class="n">shutdown_wd_action</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: could not set reset type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_DEBUG_FS</span>
</span><span class='line'>                <span class="cm">/* debugfs entry to generate a BUG during</span>
</span><span class='line'><span class="cm">                any shutdown/reboot call */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">watchdog_device</span><span class="p">.</span><span class="n">panic_reboot_notifier</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">BUG</span><span class="p">();</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                <span class="cm">/* Don&#39;t do instant reset on close */</span>
</span><span class='line'>                <span class="n">reset_on_release</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="cm">/* Kick once again */</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">disable_kernel_watchdog</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ret</span> <span class="o">=</span> <span class="n">watchdog_keepalive</span><span class="p">();</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span class='line'>                                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: no keep alive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                        <span class="cm">/* Don&#39;t allow any more keep-alives */</span>
</span><span class='line'>                        <span class="n">watchdog_device</span><span class="p">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>4. Userspace watchdog daemon</h2>

<p>Source codes are located at /hardware/ia_watchdog/watchdog_daemon folder) and target location is /usr/bin/ia_watchdogd. This daemon is declared as one-shot service in the rc file (init.watchdog.rc) and perform the following steps:</p>

<p>&mdash; open the watchdog device /dev/watchdog.<br/>
&mdash; configure the pre_timeout with 75 seconds and timeout with 90 seconds.<br/>
&mdash; Loop forever. In the loop, kick the watchdog device (by writing to &lsquo;R&rsquo; to /dev/watchdog) every 60 seconds.</p>

<h2>5. SCU watchdog leads to PLATFORM_RESET(deep reset)</h2>

<p>This prevents the platform stucking on SCU by issuing a PLATFORM_RESET because the interface between the SCU and PMIC is broken.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/27/intel-mid-overview-of-simple-platform-interface/">Intel_mid: Overview of Simple Platform Interface</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-27T15:40:00+08:00" pubdate data-updated="true">Nov 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Start to develop android kernel under X86 MID platform, merrifield.
I am a newbie for porting kernel to Atom-based platform but am familiar with linux kernel and device drivers.
Noticed that Intel Android BSP introudes Simple Firmware Interface (SFI) a method for platform firmware to export
static tables (I2C, SPI, GPIO) to the operation system.</p>

<p>Intel&rsquo;s newer Atom processors support SFI since &ldquo;Moorestown&rdquo; SoC and SFI implementation was merged into upstream kernel 2.6.32(<a href="http://lwn.net/Articles/340476">http://lwn.net/Articles/340476</a>)</p>

<p>Actually, below link descrbies the SFI and explains how does SFI related to ACPI and UEFI.
<a href="https://simplefirmware.org/faq">https://simplefirmware.org/faq</a></p>

<p>Besides, below patch sets are to refactor existing code and implement a flexible way to support multiple boards and devices.
<a href="https://lkml.org/lkml/2013/10/10/81">https://lkml.org/lkml/2013/10/10/81</a></p>

<p>/arch/x86/platform/intel-mid/intel_mid_sfi.c is SFI parsing implementation, and let me understand how get_gpio_by_name() works.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/08/android-ram-console-upstreaming/">Android Ram-console Upstreaming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-08T17:45:00+08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While dealing with board bring-up powered by Tegra5, starts to aware of this upstream change for ram console (aka /proc/last_kmsg). A working group, Android Upstreaming, comes from Linaro foundation to merge ram_console into pstore framework ( <a href="http://lwn.net/Articles/497881/">http://lwn.net/Articles/497881/</a>).</p>

<p>The Android Upstreaming team&rsquo;s mission is to reduce and eventually eliminate the differences between the upstream kernel and the Android kernel. The team works closely with Google and upstream kernel developers to find ways to implement Android required features in a way that meets the need of both communities.</p>

<p>There are currently two competing debug facilities to store kernel messages in a persistent storage: a generic pstore and Google&rsquo;s persistent_ram by Colin Cross. Not so long ago (<a href="https://lkml.org/lkml/2012/3/8/252">https://lkml.org/lkml/2012/3/8/252</a>) noticed by Greg KH@ARM Linux, it was decided to fix this situation. There is a buleprint registered by Linaro Linux to descrbie those debug facilities at <a href="https://blueprints.launchpad.net/linux-linaro/+spec/android-ram-console">https://blueprints.launchpad.net/linux-linaro/+spec/android-ram-console</a></p>

<p>To follow up android upstreaming&rsquo;s works, I remove legacy driver supporting for ram console and persistent ram and switch new pstore framework. In other words, start to looking into /sys/fs/pstore/console-ramoops as we used to did analysis on /proc/last_kmsg for dying moment across system reboot.</p>

<p>My works were merged into Asus internal development branch jb-mr2-t50-k3.10, but not opened yet. We could refer to <a href="https://android.googlesource.com/kernel/tegra/+/android-tegra-3.10">https://android.googlesource.com/kernel/tegra/+/android-tegra-3.10</a> for further reference.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/22/android-vibrator-on-msm8909-platform/">Android Vibrator on MSM8909 Platform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/07/notes-of-debugging-the-kernel-using-ftrace/">Notes of Debugging the Kernel Using Ftrace</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/12/android-renderscript-notes/">Android RenderScript Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/06/intel-mide-cpuidle-intel-idle-processor-driver-and-new-c-states/">Intel_mide: CPUIDLE: Intel_idle Processor Driver and New C-States</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/04/intel-mid-android-power-management-flow-for-suspend-slash-resume-using-s0i3-implementation/">Intel_mid: Android Power Management Flow for Suspend/resume Using S0i3 Implementation</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Han-Chun Yeh (Paris) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
